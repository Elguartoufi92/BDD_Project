version: '3.8'

services:
  # --- Config Servers (Replica Set: cfg-rs) ---
  cfg1:
    image: mongo:6.0
    container_name: cfg1
    command: mongod --configsvr --replSet cfg-rs --port 27017 --bind_ip_all
    ports:
      - "30001:27017"
    volumes:
      - ./scripts:/scripts
      - cfg1-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  cfg2:
    image: mongo:6.0
    container_name: cfg2
    command: mongod --configsvr --replSet cfg-rs --port 27017 --bind_ip_all
    ports:
      - "30002:27017"
    volumes:
      - ./scripts:/scripts
      - cfg2-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Shard A (Replica Set: shardA-rs) ---
  shA1:
    image: mongo:6.0
    container_name: shA1
    command: mongod --shardsvr --replSet shardA-rs --port 27017 --bind_ip_all
    ports:
      - "30003:27017"
    volumes:
      - ./scripts:/scripts
      - shA1-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  shA2:
    image: mongo:6.0
    container_name: shA2
    command: mongod --shardsvr --replSet shardA-rs --port 27017 --bind_ip_all
    ports:
      - "30004:27017"
    volumes:
      - ./scripts:/scripts
      - shA2-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Shard B (Replica Set: shardB-rs) ---
  shB1:
    image: mongo:6.0
    container_name: shB1
    command: mongod --shardsvr --replSet shardB-rs --port 27017 --bind_ip_all
    ports:
      - "30005:27017"
    volumes:
      - ./scripts:/scripts
      - shB1-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  shB2:
    image: mongo:6.0
    container_name: shB2
    command: mongod --shardsvr --replSet shardB-rs --port 27017 --bind_ip_all
    ports:
      - "30006:27017"
    volumes:
      - ./scripts:/scripts
      - shB2-data:/data/db
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Mongos Router ---
  mongos:
    image: mongo:6.0
    container_name: mongos
    command: mongos --configdb cfg-rs/cfg1:27017,cfg2:27017 --bind_ip_all --port 27017
    ports:
      - "27018:27017"
    depends_on:
      cfg1:
        condition: service_healthy
      cfg2:
        condition: service_healthy
      shA1:
        condition: service_healthy
      shA2:
        condition: service_healthy
      shB1:
        condition: service_healthy
      shB2:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
    networks:
      - cluster-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  cfg1-data:
  cfg2-data:
  shA1-data:
  shA2-data:
  shB1-data:
  shB2-data:

networks:
  cluster-net:
    driver: bridge